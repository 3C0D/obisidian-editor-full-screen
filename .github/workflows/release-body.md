New version with code improved